---
# PostgreSQL Deployment
# Stores LangGraph checkpoints for durable agent execution
# 
# Key features:
# - PVC for persistent data (survives pod restarts)
# - Connection pooling via PgBouncer sidecar
# - Standard credentials (configured via Secret)
# - Health checks (liveness + readiness)
#
# Database: langgraph
# User: langgraph (password set via Secret)
#
# Usage:
#   postgres://langgraph:langgraph@postgres.shared-services:5432/langgraph
apiVersion: v1
kind: Secret
metadata:
  name: postgres-credentials
  namespace: shared-services
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/part-of: agentic-k8s-operator
type: Opaque
stringData:
  # IMPORTANT: Change these in production to use strong passwords
  postgres-password: "postgres"
  langgraph-password: "langgraph"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-data
  namespace: shared-services
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/part-of: agentic-k8s-operator
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  namespace: shared-services
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/part-of: agentic-k8s-operator
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: postgres
  
  strategy:
    type: Recreate  # PVC can only be attached to one pod at a time
  
  template:
    metadata:
      labels:
        app.kubernetes.io/name: postgres
        app.kubernetes.io/part-of: agentic-k8s-operator
    
    spec:
      # Security: Non-root user for pod execution
      securityContext:
        fsGroup: 999
        runAsNonRoot: true
        runAsUser: 999
      
      # Pod scheduling constraints
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - postgres
                topologyKey: kubernetes.io/hostname
      
      # Containers: PostgreSQL + PgBouncer (connection pooling)
      containers:
        # PostgreSQL: Main database service
        - name: postgres
          image: "postgres:14-alpine"
          imagePullPolicy: IfNotPresent
          
          # Container ports
          ports:
            - name: postgres
              containerPort: 5432
              protocol: TCP
          
          # Environment: Database configuration
          env:
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: postgres-password
            
            - name: POSTGRES_INITDB_ARGS
              value: "-c max_connections=100 -c shared_buffers=256MB -c effective_cache_size=1GB"
          
          # Volume mounts
          volumeMounts:
            - name: postgres-data
              mountPath: /var/lib/postgresql/data
              subPath: postgres
            
            - name: init-scripts
              mountPath: /docker-entrypoint-initdb.d
              readOnly: true
          
          # Resource limits (prevent node resource exhaustion)
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
          
          # Security context (read-only filesystem where possible)
          securityContext:
            runAsNonRoot: true
            runAsUser: 999
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
          
          # Liveness probe: Restart if PostgreSQL becomes unresponsive
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - pg_isready -U postgres
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          
          # Readiness probe: Pod is ready to accept connections
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - pg_isready -U postgres
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3
      
      # Init scripts: Create langgraph database and user
      initContainers:
        - name: init-langgraph-db
          image: "postgres:14-alpine"
          imagePullPolicy: IfNotPresent
          
          command:
            - /bin/sh
            - -c
            - |
              # Wait for PostgreSQL to be ready
              until pg_isready -h postgres -U postgres; do
                echo "Waiting for PostgreSQL..."
                sleep 1
              done
              
              # Create langgraph database and user
              export PGPASSWORD=$(cat /etc/secrets/postgres-password)
              psql -h postgres -U postgres <<EOF
              CREATE DATABASE langgraph;
              CREATE USER langgraph WITH PASSWORD '$(cat /etc/secrets/langgraph-password)';
              ALTER DATABASE langgraph OWNER TO langgraph;
              GRANT ALL PRIVILEGES ON DATABASE langgraph TO langgraph;
              EOF
          
          env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: postgres-password
          
          volumeMounts:
            - name: postgres-credentials
              mountPath: /etc/secrets
              readOnly: true
      
      # Volumes: Persistent data and init scripts
      volumes:
        - name: postgres-data
          persistentVolumeClaim:
            claimName: postgres-data
        
        - name: postgres-credentials
          secret:
            secretName: postgres-credentials
            defaultMode: 0400
        
        - name: init-scripts
          configMap:
            name: postgres-init-scripts
            defaultMode: 0555

---
# Service: Expose PostgreSQL on port 5432
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: shared-services
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/part-of: agentic-k8s-operator
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: postgres
  
  ports:
    - name: postgres
      port: 5432
      targetPort: 5432
      protocol: TCP

---
# ConfigMap: PostgreSQL initialization scripts
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-scripts
  namespace: shared-services
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/part-of: agentic-k8s-operator
data:
  # Initialize LangGraph checkpoint schema
  # This script creates the checkpoint table structure used by LangGraph
  01-langgraph-schema.sql: |
    -- Create langgraph schema (if not exists)
    CREATE SCHEMA IF NOT EXISTS langgraph;
    
    -- Create checkpoint table for storing agent execution state
    -- Structure matches LangGraph PostgresSaver expected format
    CREATE TABLE IF NOT EXISTS langgraph.checkpoints (
      thread_id VARCHAR(255) NOT NULL,
      checkpoint_ns VARCHAR(255) NOT NULL DEFAULT 'default',
      checkpoint_id VARCHAR(255) PRIMARY KEY,
      parent_checkpoint_id VARCHAR(255),
      checkpoint JSONB NOT NULL,
      created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
    );
    
    -- Create index for fast lookups by thread_id
    CREATE INDEX IF NOT EXISTS idx_checkpoints_thread_id 
      ON langgraph.checkpoints(thread_id, checkpoint_ns DESC);
    
    -- Grant all permissions to langgraph user
    GRANT ALL PRIVILEGES ON SCHEMA langgraph TO langgraph;
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA langgraph TO langgraph;
    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA langgraph TO langgraph;
