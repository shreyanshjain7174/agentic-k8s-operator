---
# MinIO Deployment
# S3-compatible object storage for workflow artifacts
#
# Key features:
# - Single-node MinIO (appropriate for development/testing)
# - PVC for persistent data
# - S3 API on port 9000 (agents write artifacts)
# - MinIO Console on port 9001 (Web UI for debugging)
# - Health checks with probes
#
# Default credentials:
#   Access Key: minioadmin
#   Secret Key: minioadmin
#   
# Bucket: artifacts (auto-created on first workflow run)
#
# Usage:
#   s3://artifacts/job_<id>/raw_html.json
#   s3://artifacts/job_<id>/screenshots/
#   s3://artifacts/job_<id>/dom_structures.json
#   s3://artifacts/job_<id>/report.md
apiVersion: v1
kind: Secret
metadata:
  name: minio-credentials
  namespace: shared-services
  labels:
    app.kubernetes.io/name: minio
    app.kubernetes.io/part-of: agentic-k8s-operator
type: Opaque
stringData:
  # IMPORTANT: Change these in production
  access-key: "minioadmin"
  secret-key: "minioadmin"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: minio-data
  namespace: shared-services
  labels:
    app.kubernetes.io/name: minio
    app.kubernetes.io/part-of: agentic-k8s-operator
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
  storageClassName: standard
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: minio
  namespace: shared-services
  labels:
    app.kubernetes.io/name: minio
    app.kubernetes.io/part-of: agentic-k8s-operator
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: minio
  
  strategy:
    type: Recreate  # PVC can only be attached to one pod at a time
  
  template:
    metadata:
      labels:
        app.kubernetes.io/name: minio
        app.kubernetes.io/part-of: agentic-k8s-operator
    
    spec:
      # Security context
      securityContext:
        fsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      
      # Containers
      containers:
        - name: minio
          image: "minio/minio:latest"
          imagePullPolicy: IfNotPresent
          
          # Startup command (run in S3 server mode)
          command:
            - minio
            - server
            - /data
            - --console-address
            - ":9001"
          
          # Ports
          ports:
            - name: s3-api
              containerPort: 9000
              protocol: TCP
            - name: console
              containerPort: 9001
              protocol: TCP
          
          # Environment: Credentials and configuration
          env:
            - name: MINIO_ROOT_USER
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: access-key
            
            - name: MINIO_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: secret-key
            
            # Browser: Enable MinIO console
            - name: MINIO_BROWSER
              value: "on"
            
            # Logging: Structured JSON logs
            - name: MINIO_LOG_QUERY_STRING
              value: "on"
          
          # Volume mounts
          volumeMounts:
            - name: minio-data
              mountPath: /data
          
          # Resource limits
          resources:
            requests:
              cpu: "250m"
              memory: "256Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"
          
          # Security context
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
          
          # Liveness probe: Restart if MinIO becomes unresponsive
          livenessProbe:
            httpGet:
              path: /minio/health/live
              port: 9000
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          
          # Readiness probe: Pod is ready to serve requests
          readinessProbe:
            httpGet:
              path: /minio/health/ready
              port: 9000
              scheme: HTTP
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3
      
      # Init container: Create artifacts bucket
      initContainers:
        - name: init-bucket
          image: "minio/mc:latest"
          imagePullPolicy: IfNotPresent
          
          command:
            - /bin/sh
            - -c
            - |
              # Wait for MinIO to be ready
              until mc ls minio-local/ 2>/dev/null; do
                echo "Waiting for MinIO..."
                sleep 1
              done
              
              # Create artifacts bucket if it doesn't exist
              if ! mc ls minio-local/artifacts >/dev/null 2>&1; then
                echo "Creating artifacts bucket..."
                mc mb minio-local/artifacts
                echo "Bucket created successfully"
              else
                echo "Artifacts bucket already exists"
              fi
          
          env:
            - name: MC_HOST_minio-local
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: access-key
            
            # Note: MC_HOST_minio-local format is: http://accesskey:secretkey@host:port
            # This is set by the initContainer script logic
      
      # Volumes
      volumes:
        - name: minio-data
          persistentVolumeClaim:
            claimName: minio-data

---
# Service: S3 API (port 9000)
# Used by agents to upload/download artifacts
apiVersion: v1
kind: Service
metadata:
  name: minio
  namespace: shared-services
  labels:
    app.kubernetes.io/name: minio
    app.kubernetes.io/part-of: agentic-k8s-operator
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: minio
  
  ports:
    - name: s3-api
      port: 9000
      targetPort: 9000
      protocol: TCP
    
    - name: console
      port: 9001
      targetPort: 9001
      protocol: TCP

---
# Service: MinIO Console (port 9001)
# Provides Web UI for debugging and artifact inspection
apiVersion: v1
kind: Service
metadata:
  name: minio-console
  namespace: shared-services
  labels:
    app.kubernetes.io/name: minio
    app.kubernetes.io/part-of: agentic-k8s-operator
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: minio
  
  ports:
    - name: console
      port: 9001
      targetPort: 9001
      protocol: TCP
