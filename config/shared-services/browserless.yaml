---
# Browserless Deployment
# Provides headless Chrome for screenshot and DOM extraction
#
# Key features:
# - Headless Chrome with Puppeteer API
# - WebSocket API on port 3000 (native Argo integration)
# - Resource limits to prevent OOMKilled
# - Health checks with probes
#
# WebSocket API:
#   ws://browserless.shared-services:3000
#
# Example API calls (from agents):
#   { "url": "https://example.com" }  → Full-page screenshot (PNG)
#   { "url": "...", "action": "getDOM" } → DOM structure (HTML string)
#
# Usage (Python):
#   import websocket
#   ws = websocket.connect("ws://browserless:3000")
#   screenshot = ws.send({"url": "https://example.com"})
apiVersion: apps/v1
kind: Deployment
metadata:
  name: browserless
  namespace: shared-services
  labels:
    app.kubernetes.io/name: browserless
    app.kubernetes.io/part-of: agentic-k8s-operator
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: browserless
  
  template:
    metadata:
      labels:
        app.kubernetes.io/name: browserless
        app.kubernetes.io/part-of: agentic-k8s-operator
    
    spec:
      # Security context
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      
      # Containers
      containers:
        - name: browserless
          image: "browserless/base:latest"
          imagePullPolicy: IfNotPresent
          
          # Ports
          ports:
            - name: ws
              containerPort: 3000
              protocol: TCP
          
          # Environment: Configuration
          env:
            # Chrome/Chromium sandbox: Disable for containerized environment
            - name: DISABLE_SANDBOX
              value: "true"
            
            # Connection timeout (in milliseconds)
            - name: CONNECTION_TIMEOUT
              value: "30000"
            
            # Max concurrent requests
            - name: MAX_CONCURRENT_SESSIONS
              value: "5"
            
            # Enable debugging
            - name: DEBUG
              value: "false"
            
            # Default timeout for browser operations (milliseconds)
            - name: DEFAULT_NAVIGATE_TIMEOUT
              value: "30000"
          
          # Resource limits (CRITICAL: Browser memory usage is high)
          resources:
            requests:
              cpu: "500m"
              memory: "512Mi"
            limits:
              cpu: "2000m"
              memory: "2Gi"  # Chrome can use up to 2GB
          
          # Security context
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false  # Chrome needs write access to /tmp
            capabilities:
              drop:
                - ALL
          
          # Volume mounts
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: home
              mountPath: /home/browserless
          
          # Liveness probe: Restart if Browserless becomes unresponsive
          livenessProbe:
            httpGet:
              path: /health
              port: 3000
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          
          # Readiness probe: Pod is ready to accept WebSocket connections
          readinessProbe:
            httpGet:
              path: /metrics
              port: 3000
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3
      
      # Volumes: Temporary storage for Chrome
      volumes:
        - name: tmp
          emptyDir: {}
        - name: home
          emptyDir: {}

---
# Service: WebSocket API
# Exposes Browserless on port 3000 for agents to connect
apiVersion: v1
kind: Service
metadata:
  name: browserless
  namespace: shared-services
  labels:
    app.kubernetes.io/name: browserless
    app.kubernetes.io/part-of: agentic-k8s-operator
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: browserless
  
  ports:
    - name: ws
      port: 3000
      targetPort: 3000
      protocol: TCP
